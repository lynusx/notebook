# dart:ffi -- 外部函数接口库

Foreign Function Interface，允许 Dart 代码调用原生 C API，实现与原生代码的高性能互操作。

### 1.1 核心能力

- 原生内存操作（Pointer、allocate、free、malloc、calloc）
- 原生类型映射（Int8、Int16、Int32、Int64、Uint8、Uint16、Uint32、Uint64、Float、Double、Void、NativeFunction）
- 结构体与联合体（Struct、Union、Packed）
- 动态库加载（DynamicLibrary、DynamicLibrary.open、DynamicLibrary.process、DynamicLibrary.executable）
- 异步回调（NativeCallable、NativeCallable.listener）
- 数组与字符串（Array、Utf8、Utf16）

### 1.2 库结构

```dart
dart:ffi
│
├── 指针与内存
│   ├── Pointer<T>                # 原生指针 (指向任意原生类型)
│   ├── Pointer<NativeFunction<T>># 函数指针 (指向原生函数)
│   ├── nullptr                   # 空指针常量
│   ├── malloc()                  # C 标准库内存分配
│   ├── calloc()                  # C 标准库清零内存分配
│   ├── free()                    # C 标准库内存释放
│   ├── sizeOf<T>()               # 获取原生类型字节大小
│   ├── addressOf()               # 获取变量内存地址
│   ├── cast<T>()                 # 指针类型转换
│   ├── offsetBy()                # 指针偏移计算
│   ├── elementAt()               # 元素指针访问 (数组索引)
│   ├── value                     # 解引用获取/设置值
│   └── asTypedList()             # 转为 Dart TypedData 视图
│
├── 原生类型
│   ├── NativeType                # 所有原生类型的抽象基类
│   ├── Void                      # C void 类型
│   ├── Int8                      # 8 位有符号整数
│   ├── Int16                     # 16 位有符号整数
│   ├── Int32                     # 32 位有符号整数
│   ├── Int64                     # 64 位有符号整数
│   ├── Uint8                     # 8 位无符号整数
│   ├── Uint16                    # 16 位无符号整数
│   ├── Uint32                    # 32 位无符号整数
│   ├── Uint64                    # 64 位无符号整数
│   ├── Float                     # 32 位单精度浮点
│   ├── Double                    # 64 位双精度浮点
│   ├── Bool                      # C bool 类型
│   ├── NativeFunction<T>         # 原生函数类型标记
│   ├── Handle                    # Dart 对象句柄 (跨语言持有)
│   ├── Opaque                    # 不透明类型 (C 结构体前向声明)
│   └── VarArgs                   # 可变参数函数标记 (Dart 3.0+)
│
├── 复合类型
│   ├── Struct                    # C 结构体基类 (@Packed 支持)
│   ├── Union                     # C 联合体基类 (Dart 2.14+)
│   ├── Array<T>                  # 固定大小原生数组
│   └── Packed                    # 结构体紧凑对齐注解
│
├── 动态库
│   ├── DynamicLibrary            # 动态链接库操作
│   ├── DynamicLibrary.open()     # 打开动态库文件 (.so/.dll/.dylib)
│   ├── DynamicLibrary.process()  # 当前进程符号表
│   ├── DynamicLibrary.executable()# 可执行文件符号表
│   ├── DynamicLibrary.lookup()   # 查找符号地址
│   ├── DynamicLibrary.lookupFunction<T, F>() # 查找并包装函数
│   └── DynamicLibrary.providesSymbol() # 检查符号是否存在
│
├── 回调与异步
│   ├── NativeCallable<T>         # Dart 函数包装为原生可调用对象
│   ├── NativeCallable.isolateLocal() # 绑定当前隔离区的同步回调
│   └── NativeCallable.listener() # 异步回调 (通过 Port 通信)
│
├── 平台特定类型
│   ├── Abi                       # 应用二进制接口枚举 (x64/arm64等)
│   ├── AbiSpecificInteger        # ABI 特定整数基类
│   ├── IntPtr                    # 指针大小有符号整数 (平台相关)
│   ├── UintPtr                   # 指针大小无符号整数 (平台相关)
│   └── Size                      # C size_t 类型别名
│
└── 辅助工具
    ├── FfiNative<T>              # 原生函数直接绑定注解
    ├── FfiStruct                 # 结构体内部使用标记
    ├── allocate<T>()             # 旧版内存分配 (已弃用，用 malloc)
    └── reallocate<T>()           # 旧版内存重分配 (已弃用)
```



---

